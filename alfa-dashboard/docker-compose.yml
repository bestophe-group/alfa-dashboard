version: '3.8'

# ========================================
# ALFA DASHBOARD - Docker Compose Stack
# ========================================

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  huly_data:
  infisical_data:
  n8n_data:
  uptime_kuma_data:
  traefik_letsencrypt:

services:
  # ========================================
  # Traefik - Reverse Proxy & SSL
  # ========================================
  traefik:
    image: traefik:v2.11
    container_name: alfa-traefik
    restart: unless-stopped
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - traefik_letsencrypt:/letsencrypt
    environment:
      - ACME_EMAIL=${ACME_EMAIL}
    networks:
      - frontend
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # PostgreSQL - Shared Database
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: alfa-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Redis - Cache & Session Store
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: alfa-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Huly - Project Management
  # ========================================
  huly:
    image: hardcoreeng/huly:latest
    container_name: alfa-huly
    restart: unless-stopped
    environment:
      - SERVER_SECRET=${HULY_SECRET}
      - MONGO_URL=mongodb://mongo:27017/huly
    volumes:
      - huly_data:/data
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.huly.rule=Host(`huly.${DOMAIN}`)"
      - "traefik.http.routers.huly.entrypoints=websecure"
      - "traefik.http.routers.huly.tls.certresolver=letsencrypt"
      - "traefik.http.services.huly.loadbalancer.server.port=${HULY_PORT:-3000}"
    depends_on:
      - mongo
      - traefik
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB pour Huly
  mongo:
    image: mongo:7
    container_name: alfa-mongo
    restart: unless-stopped
    volumes:
      - huly_data:/data/db
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Infisical - Secrets Management
  # ========================================
  infisical:
    image: infisical/infisical:latest
    container_name: alfa-infisical
    restart: unless-stopped
    environment:
      - DB_CONNECTION_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SITE_URL=https://infisical.${DOMAIN}
      - ENCRYPTION_KEY=${INFISICAL_TOKEN}
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.infisical.rule=Host(`infisical.${DOMAIN}`)"
      - "traefik.http.routers.infisical.entrypoints=websecure"
      - "traefik.http.routers.infisical.tls.certresolver=letsencrypt"
      - "traefik.http.services.infisical.loadbalancer.server.port=${INFISICAL_PORT:-8080}"
    depends_on:
      - postgres
      - redis
      - traefik
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/status/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # n8n - Workflow Automation
  # ========================================
  n8n:
    image: n8nio/n8n:latest
    container_name: alfa-n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - N8N_HOST=n8n.${DOMAIN}
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.${DOMAIN}/
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=${N8N_PORT:-5678}"
    depends_on:
      - postgres
      - traefik
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # Uptime Kuma - Monitoring
  # ========================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: alfa-uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_kuma_data:/app/data
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime.rule=Host(`uptime.${DOMAIN}`)"
      - "traefik.http.routers.uptime.entrypoints=websecure"
      - "traefik.http.routers.uptime.tls.certresolver=letsencrypt"
      - "traefik.http.services.uptime.loadbalancer.server.port=${UPTIME_KUMA_PORT:-3001}"
    depends_on:
      - traefik
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3
