name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose syntax
        run: docker compose config > /dev/null

      - name: Check file structure
        run: |
          echo "Checking required files..."
          [ -f docker-compose.yml ] && echo "✓ docker-compose.yml"
          [ -f .env.example ] && echo "✓ .env.example"
          [ -f README.md ] && echo "✓ README.md"
          [ -f traefik/traefik.yml ] && echo "✓ traefik/traefik.yml"
          [ -f scripts/setup.sh ] && echo "✓ scripts/setup.sh"
          [ -f scripts/backup.sh ] && echo "✓ scripts/backup.sh"
          [ -f scripts/health-check.sh ] && echo "✓ scripts/health-check.sh"

  test-structure:
    name: Test Stack Structure
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: cp .env.example .env

      - name: Run structure tests
        run: |
          cd tests
          chmod +x test-stack.sh
          ./test-stack.sh

  test-deployment:
    name: Test Full Deployment
    runs-on: ubuntu-latest
    needs: test-structure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          cp .env.example .env
          # Generate secure passwords for testing
          sed -i 's/changeme/test_password_123/g' .env

      - name: Create required directories
        run: |
          mkdir -p traefik/letsencrypt
          touch traefik/letsencrypt/acme.json
          chmod 600 traefik/letsencrypt/acme.json

      - name: Start services
        run: docker compose up -d

      - name: Wait for services to be ready
        run: sleep 60

      - name: Check service health
        run: docker compose ps

      - name: Run endpoint tests
        run: |
          cd tests
          chmod +x test-endpoints.sh
          ./test-endpoints.sh || true

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, test-structure, test-deployment, security]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "CI/CD Pipeline completed!"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Structure Tests: ${{ needs.test-structure.result }}"
          echo "Deployment Tests: ${{ needs.test-deployment.result }}"
          echo "Security Scan: ${{ needs.security.result }}"
