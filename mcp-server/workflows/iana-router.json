{
  "name": "iana-router",
  "nodes": [
    {
      "parameters": {"httpMethod": "POST", "path": "iana", "responseMode": "responseNode"},
      "id": "webhook", "name": "Webhook", "type": "n8n-nodes-base.webhook",
      "typeVersion": 1, "position": [240, 300]
    },
    {
      "parameters": {"jsCode": "return {json: {query: $input.item.json.body.query, user_id: $input.item.json.body.user_id || 'anon', channel: $input.item.json.body.channel || 'api'}};"},
      "id": "parse", "name": "Parse", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [460, 300]
    },
    {
      "parameters": {"operation": "executeQuery", "query": "INSERT INTO iana.conversations (user_id, channel) VALUES ($1, $2) ON CONFLICT DO NOTHING RETURNING conversation_id"},
      "id": "conversation", "name": "Conversation", "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4, "position": [680, 300]
    },
    {
      "parameters": {"jsCode": "const query = $('parse').item.json.query || ''; const prompt = `Classify: L1/L2/L3. Query: ${query}. Respond JSON: {\\\"tier\\\":\\\"LX\\\",\\\"confidence\\\":0.9}`; const escaped = prompt.replace(/\"/g, '\\\\\"').replace(/\\$/g, '\\\\$'); return {json: {command: `node /Users/arnaud/Documents/ALFA-Agent-Method/alfa-dashboard/scripts/llm-cli-wrapper.js claude-code \"${escaped}\" claude-3-haiku`, query: query}};"},
      "id": "prepare-classifier", "name": "Prepare Classifier", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [900, 300]
    },
    {
      "parameters": {"jsCode": "const { execSync } = require('child_process'); const command = $input.first().json.command || ''; try { const result = execSync(command, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024, timeout: 30000 }); let cliResponse; try { cliResponse = JSON.parse(result.trim()); } catch (e) { cliResponse = { response: result.trim() }; } return [{ json: { stdout: result.trim(), ...cliResponse } }]; } catch (error) { return [{ json: { stdout: '', stderr: error.message, error: error.message } }]; }"},
      "id": "classifier", "name": "Classifier (CLI)", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1120, 300]
    },
    {
      "parameters": {"jsCode": "let cliResponse; try { const cliOutput = $input.item.json.stdout || $input.item.json.stderr || '{}'; cliResponse = JSON.parse(cliOutput.trim()); } catch (e) { cliResponse = { response: $input.item.json.stdout || '{}' }; } let r; try { const jsonMatch = cliResponse.response.match(/\\{[^}]+\\}/); r = jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(cliResponse.response); } catch (e) { r = { tier: 'L1', confidence: 0.5 }; } return {json: {tier: r.tier || 'L1', confidence: r.confidence || 0.5}};"},
      "id": "parseClass", "name": "ParseClass", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1340, 300]
    },
    {
      "parameters": {"conditions": {"string": [{"value1": "={{ $json.tier }}", "value2": "L1"}]}},
      "id": "switch", "name": "Switch", "type": "n8n-nodes-base.switch",
      "typeVersion": 1, "position": [1340, 300]
    },
    {
      "parameters": {"jsCode": "const query = $('parse').item.json.query || ''; const prompt = `${query}\\n\\nRespond helpfully and concisely.`; const escaped = prompt.replace(/\"/g, '\\\\\"').replace(/\\$/g, '\\\\$'); return {json: {command: `node /Users/arnaud/Documents/ALFA-Agent-Method/alfa-dashboard/scripts/llm-cli-wrapper.js claude-code \"${escaped}\" claude-3-haiku`}};"},
      "id": "prepare-l1", "name": "Prepare L1", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1560, 120]
    },
    {
      "parameters": {"jsCode": "const { execSync } = require('child_process'); const command = $input.first().json.command || ''; try { const result = execSync(command, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024, timeout: 30000 }); let cliResponse; try { cliResponse = JSON.parse(result.trim()); } catch (e) { cliResponse = { response: result.trim() }; } return [{ json: { stdout: result.trim(), ...cliResponse } }]; } catch (error) { return [{ json: { stdout: '', stderr: error.message, error: error.message } }]; }"},
      "id": "l1", "name": "L1-Haiku (CLI)", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1780, 120]
    },
    {
      "parameters": {"jsCode": "return {json: {tier: 'L2', response: 'Workflow executed', latency_ms: 500}};"},
      "id": "l2", "name": "L2-Workflow", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1560, 300]
    },
    {
      "parameters": {"jsCode": "const query = $('parse').item.json.query || ''; const prompt = `You are an expert AI assistant. Analyze this query deeply: ${query}`; const escaped = prompt.replace(/\"/g, '\\\\\"').replace(/\\$/g, '\\\\$'); return {json: {command: `node /Users/arnaud/Documents/ALFA-Agent-Method/alfa-dashboard/scripts/llm-cli-wrapper.js cursor-agent \"${escaped}\" claude-3-5-sonnet`}};"},
      "id": "prepare-l3", "name": "Prepare L3", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1560, 480]
    },
    {
      "parameters": {"jsCode": "const { execSync } = require('child_process'); const command = $input.first().json.command || ''; try { const result = execSync(command, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024, timeout: 60000 }); let cliResponse; try { cliResponse = JSON.parse(result.trim()); } catch (e) { cliResponse = { response: result.trim() }; } return [{ json: { stdout: result.trim(), ...cliResponse } }]; } catch (error) { return [{ json: { stdout: '', stderr: error.message, error: error.message } }]; }"},
      "id": "l3", "name": "L3-Sonnet (CLI)", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1780, 480]
    },
    {
      "parameters": {"operation": "executeQuery", "query": "INSERT INTO iana.messages (conversation_id, role, content) VALUES ($1, 'user', $2)"},
      "id": "loguser", "name": "LogUser", "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4, "position": [1780, 300]
    },
    {
      "parameters": {"operation": "executeQuery", "query": "INSERT INTO iana.messages (conversation_id, role, content, tier) VALUES ($1, 'assistant', $2, $3) RETURNING message_id"},
      "id": "logassist", "name": "LogAssist", "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4, "position": [2000, 300]
    },
    {
      "parameters": {"jsCode": "let response = ''; const input = $input.item.json; if (input.stdout) { try { const cli = JSON.parse(input.stdout.trim()); response = cli.response || cli.text || input.stdout; } catch (e) { response = input.stdout; } } else { response = input.response || input.text || 'No response'; } return {json: {tier: $('parseClass').item.json.tier, response: response}};"},
      "id": "format-response", "name": "Format Response", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [2000, 300]
    },
    {
      "parameters": {"respondWith": "json", "responseBody": "={{ {tier: $json.tier, response: $json.response} }}"},
      "id": "respond", "name": "Respond", "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1, "position": [2220, 300]
    }
  ],
  "connections": {
    "webhook": {"main": [[{"node": "parse", "type": "main", "index": 0}]]},
    "parse": {"main": [[{"node": "conversation", "type": "main", "index": 0}]]},
    "conversation": {"main": [[{"node": "Prepare Classifier", "type": "main", "index": 0}]]},
    "Prepare Classifier": {"main": [[{"node": "Classifier (CLI)", "type": "main", "index": 0}]]},
    "Classifier (CLI)": {"main": [[{"node": "parseClass", "type": "main", "index": 0}]]},
    "parseClass": {"main": [[{"node": "switch", "type": "main", "index": 0}]]},
    "switch": {
      "main": [
        [{"node": "Prepare L1", "type": "main", "index": 0}],
        [{"node": "l2", "type": "main", "index": 0}],
        [{"node": "Prepare L3", "type": "main", "index": 0}]
      ]
    },
    "Prepare L1": {"main": [[{"node": "L1-Haiku (CLI)", "type": "main", "index": 0}]]},
    "L1-Haiku (CLI)": {"main": [[{"node": "loguser", "type": "main", "index": 0}]]},
    "l2": {"main": [[{"node": "loguser", "type": "main", "index": 0}]]},
    "Prepare L3": {"main": [[{"node": "L3-Sonnet (CLI)", "type": "main", "index": 0}]]},
    "L3-Sonnet (CLI)": {"main": [[{"node": "loguser", "type": "main", "index": 0}]]},
    "loguser": {"main": [[{"node": "logassist", "type": "main", "index": 0}]]},
    "logassist": {"main": [[{"node": "format-response", "type": "main", "index": 0}]]},
    "format-response": {"main": [[{"node": "respond", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {},
  "id": "iana-router"
}
