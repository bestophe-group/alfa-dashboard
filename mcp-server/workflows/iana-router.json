{
  "name": "iana-router",
  "nodes": [
    {
      "parameters": {"httpMethod": "POST", "path": "iana", "responseMode": "responseNode"},
      "id": "webhook", "name": "Webhook", "type": "n8n-nodes-base.webhook",
      "typeVersion": 1, "position": [240, 300]
    },
    {
      "parameters": {"jsCode": "return {json: {query: $input.item.json.body.query, user_id: $input.item.json.body.user_id || 'anon', channel: $input.item.json.body.channel || 'api'}};"},
      "id": "parse", "name": "Parse", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [460, 300]
    },
    {
      "parameters": {"operation": "executeQuery", "query": "INSERT INTO iana.conversations (user_id, channel) VALUES ($1, $2) ON CONFLICT DO NOTHING RETURNING conversation_id"},
      "id": "conversation", "name": "Conversation", "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4, "position": [680, 300]
    },
    {
      "parameters": {"model": "claude-3-haiku-20240307", "prompt": "Classify: L1/L2/L3. Query: {{ $json.query }}. Respond JSON: {\"tier\":\"LX\",\"confidence\":0.9}"},
      "id": "classifier", "name": "Classifier", "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1, "position": [900, 300]
    },
    {
      "parameters": {"jsCode": "const r = JSON.parse($input.item.json.response); return {json: {tier: r.tier, confidence: r.confidence}};"},
      "id": "parseClass", "name": "ParseClass", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1120, 300]
    },
    {
      "parameters": {"conditions": {"string": [{"value1": "={{ $json.tier }}", "value2": "L1"}]}},
      "id": "switch", "name": "Switch", "type": "n8n-nodes-base.switch",
      "typeVersion": 1, "position": [1340, 300]
    },
    {
      "parameters": {"model": "claude-3-haiku-20240307", "prompt": "={{ $('parse').item.json.query }}"},
      "id": "l1", "name": "L1-Haiku", "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1, "position": [1560, 120]
    },
    {
      "parameters": {"jsCode": "return {json: {tier: 'L2', response: 'Workflow executed', latency_ms: 500}};"},
      "id": "l2", "name": "L2-Workflow", "type": "n8n-nodes-base.code",
      "typeVersion": 2, "position": [1560, 300]
    },
    {
      "parameters": {"model": "claude-3-5-sonnet-20241022", "prompt": "={{ $('parse').item.json.query }}"},
      "id": "l3", "name": "L3-Sonnet", "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1, "position": [1560, 480]
    },
    {
      "parameters": {"operation": "executeQuery", "query": "INSERT INTO iana.messages (conversation_id, role, content) VALUES ($1, 'user', $2)"},
      "id": "loguser", "name": "LogUser", "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4, "position": [1780, 300]
    },
    {
      "parameters": {"operation": "executeQuery", "query": "INSERT INTO iana.messages (conversation_id, role, content, tier) VALUES ($1, 'assistant', $2, $3) RETURNING message_id"},
      "id": "logassist", "name": "LogAssist", "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4, "position": [2000, 300]
    },
    {
      "parameters": {"respondWith": "json", "responseBody": "={{ {tier: $json.tier, response: $json.response} }}"},
      "id": "respond", "name": "Respond", "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1, "position": [2220, 300]
    }
  ],
  "connections": {
    "webhook": {"main": [[{"node": "parse", "type": "main", "index": 0}]]},
    "parse": {"main": [[{"node": "conversation", "type": "main", "index": 0}]]},
    "conversation": {"main": [[{"node": "classifier", "type": "main", "index": 0}]]},
    "classifier": {"main": [[{"node": "parseClass", "type": "main", "index": 0}]]},
    "parseClass": {"main": [[{"node": "switch", "type": "main", "index": 0}]]},
    "switch": {
      "main": [
        [{"node": "l1", "type": "main", "index": 0}],
        [{"node": "l2", "type": "main", "index": 0}],
        [{"node": "l3", "type": "main", "index": 0}]
      ]
    },
    "l1": {"main": [[{"node": "loguser", "type": "main", "index": 0}]]},
    "l2": {"main": [[{"node": "loguser", "type": "main", "index": 0}]]},
    "l3": {"main": [[{"node": "loguser", "type": "main", "index": 0}]]},
    "loguser": {"main": [[{"node": "logassist", "type": "main", "index": 0}]]},
    "logassist": {"main": [[{"node": "respond", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {},
  "id": "iana-router"
}
